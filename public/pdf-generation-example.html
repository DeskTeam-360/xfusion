<script>
    (function () {
      function canvasToImgClone(sourceRoot, cloneRoot) {
        const sourceCanvases = sourceRoot.querySelectorAll('canvas');
        const cloneCanvases  = cloneRoot.querySelectorAll('canvas');
        sourceCanvases.forEach((cv, i) => {
          try {
            // ensure chart is rendered; if needed, you can delay capture slightly
            const dataURL = cv.toDataURL('image/png'); 
            const img = document.createElement('img');
            // keep sizing consistent with your fixed canvas size
            const w = cv.getAttribute('width')  || cv.width  || 600;
            const h = cv.getAttribute('height') || cv.height || 600;
            img.width = w; img.height = h; img.src = dataURL;
            if (cloneCanvases[i]) cloneCanvases[i].replaceWith(img);
          } catch(e) {
            // if canvas is tainted or not ready, we just leave the canvas as-is
          }
        });
      }

      function printOnly(selector) {
        const source = document.querySelector(selector);
        if (!source) { alert('Printable element not found: ' + selector); return; }

        // Clone the report content
        const clone = source.cloneNode(true);
        // Replace canvases with images so they reliably print
        canvasToImgClone(source, clone);

        // Create hidden iframe as a clean print document
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(`
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8">
              <title>Report PDF</title>
              <style>
                html, body {
                  margin: 0;
                  margin-left: -1.5rem;
                  padding: 0;
                  font-family: "Bebas Neue", Arial, sans-serif;
                  font-size: 18px !important;
                  background: #fff;
                  color: #000;
                  width: 100%;
                }

                body {
                  /* give wide content area */
                  padding: 10mm 15mm; /* adjust margins: top/bottom, left/right */
                }

                .grit-for-print {
                  width: 100%;
                  max-width: 100%; /* remove any Elementor limits */
                }

                .print-page {
                  width: 100%;
                  max-width: 100%;
                  page-break-after: always;
                  page-break-inside: avoid;
                }

                .print-page:last-child {
                  page-break-after: auto;
                }
              </style>
            </head>
            <body></body>
          </html>
        `);
        doc.close();

        // Insert cloned content into the clean print doc
        doc.body.appendChild(clone);

        // Wait for images (including canvas snapshots) before printing
        const images = doc.images;
        const waits = [];
        for (let i = 0; i < images.length; i++) {
          waits.push(new Promise(res => {
            if (images[i].complete) return res();
            images[i].addEventListener('load',  res, { once:true });
            images[i].addEventListener('error', res, { once:true });
          }));
        }

        Promise.all(waits).then(() => {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
          // clean up
          setTimeout(() => document.body.removeChild(iframe), 1000);
        });
      }

      // Hook the button
      document.addEventListener('click', function (e) {
        if (e.target && e.target.id === 'printReportBtn') {
          // If your Chart.js just rendered, a tiny delay helps ensure canvas is ready
          requestAnimationFrame(() => requestAnimationFrame(() => printOnly('.grit-for-print')));
        }
      });
    })();
    </script>